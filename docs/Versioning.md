Versioning
==========

## The Problem

Let's say Calchart is up and running and Stunt's using it to chart their shows. Then someone wants to have each Show store the date of the performance. We could go ahead and add it, but then all the Shows that have already been created will not have that date defined. Sure, we could add a default in the code (`this._date = _.defaultTo(date, new Date())`) but then our code could eventually get bloated with a bunch of catching defaults for un-updated shows. Furthermore, this would mean old shows aren't updated until they're opened on Calchart. This means we could potentially have really old and un-updated shows in the database.

## Django Migrations

To alleviate this problem and follow the same idiom as Django models, we'll be using a VERSION variable in our code that will indicate the current version of the Show (i.e. all other Shows that serialize to the same JSON data). All newly created shows will be initialized with this version, but old shows will still have the old version.

We'll then use Django migrations to update all shows of the previous version to the newer version. One benefit of using Django migrations is that Django figures out for us which migrations have already been run; i.e. it remembers that we already migrated all Shows up to version X and only have to apply the last migration to update it to version X + 1.

To make a new migration, run `python vmanage.py makemigrations base --empty`. This will create a file in `calchart/base/migrations` with a name like `00XX_auto_yyyymmdd_HHMM.py`. Rename this file to be `version_X.py`, where `X` is the version number you're updating to (i.e. if you're updating from version 2 to 3, name it `version_3.py`). Update the file to look something like this:

```
# -*- coding: utf-8 -*-
# Generated by Django 1.9 on 2017-01-22 07:52
from __future__ import unicode_literals

from django.db import migrations
from utils.db import UpdateShowVersion

def update_version(show):
    # any actions to update Show to next version
    show['date'] = '2017-01-01'

class Migration(migrations.Migration):

    dependencies = [
        ('base', 'version_2'),
    ]

    operations = [
        UpdateShowVersion(3, update_version)
    ]
```

`UpdateShowVersion` takes in two parameters: the first is the version being updated to and the second is a function that will be called on each Show in the database with an outdated version. `update_version` takes in a show's viewer file (result of Show.serialize() in the Javascript) and modifies the JSON data to update the Show to the next version.
