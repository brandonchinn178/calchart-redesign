---
- hosts: all # which URLs to run this ansible script for, but will only be used in
             # setting up Vagrant (not CircleCI or Heroku).
  gather_facts: False # don't need information about the remote computer

  vars:
    ROOT_DIR: /vagrant
    HOME_DIR: /home/vagrant
    dbname: calchart_db
    dbuser: calchart_user
    dbpassword: calbandgreat

  tasks:

    # APT

    - name: update the apt cache
      apt: update_cache=yes # ensure all packages are up to date before installing with apt-get

    # DATABASE

    - name: ensure database is created
      become_user: postgres
      postgresql_db: name={{ dbname }} # will create a database with the given name

    - name: ensure user has access
      become_user: postgres
      # create a user for the database. Grant them all privileges and allow them to create databases
      postgresql_user:
        db: "{{ dbname }}"
        name: "{{ dbuser }}"
        password: "{{ dbpassword }}"
        priv: ALL
        role_attr_flags: CREATEDB

    # PYTHON

    - name: install requirements.txt
      pip:
        executable: pip3
        requirements: "{{ ROOT_DIR }}/requirements/dev.txt"

    # NODE

    - name: install npm packages
      command: npm install {{ ROOT_DIR }} --no-bin-links

    # DJANGO

    - name: run django setup actions
      script: "{{ ROOT_DIR }}/vagrant/django_setup.sh"
